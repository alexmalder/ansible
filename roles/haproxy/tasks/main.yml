---
- name: Install haproxy
  ansible.builtin.yum:
    name: haproxy

- name: Push temp configuration
  ansible.builtin.copy:
    src: "roles/haproxy/files/{{ ansible_hostname }}.cfg"
    dest: /etc/haproxy/haproxy_temp.cfg
    owner: haproxy
    group: haproxy
    mode: 0640

- name: Check config
  ansible.builtin.command: haproxy -f /etc/haproxy/haproxy_temp.cfg -c
  register: validation_result
  failed_when: validation_result.rc != 0

- name: Push configuration
  ansible.builtin.copy:
    src: "roles/haproxy/files/{{ ansible_hostname }}.cfg"
    dest: /etc/haproxy/haproxy.cfg
    owner: haproxy
    group: haproxy
    mode: 0640

- name: Push service
  ansible.builtin.copy:
    src: roles/haproxy/files/haproxy.service
    dest: /usr/lib/systemd/system/haproxy.service
    owner: haproxy
    group: haproxy
    mode: 0640

- name: Enable and restart haproxy service
  ansible.builtin.systemd:
    name: haproxy
    state: restarted
    enabled: true
    daemon_reload: true
