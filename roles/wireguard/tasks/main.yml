---
# tasks file for wireguard
- name: Register secure variables
  command: pass show config/wireguard.yml
  register: wireguard
  changed_when: wireguard.rc == 0
  failed_when: wireguard.rc != 0

- name: Set fact from secure variables
  ansible.builtin.set_fact:
    wg_config: "{{ wireguard.stdout | from_yaml }}"

- name: Create wireguard directory if does no exists
  ansible.builtin.file:
    path: "/etc/wireguard"
    state: directory
    owner: vnmntn
    mode: 0640
  become: true

- name: Generate client config files
  ansible.builtin.template:
    src: "roles/wireguard/templates/client.conf"
    dest: "/etc/wireguard/{{ item.name }}.conf"
    owner: vnmntn
    mode: 0640
  loop: "{{ wg_config.clients }}"
  no_log: true
  become: true

- name: Generate server config file
  ansible.builtin.template:
    src: roles/wireguard/templates/server.conf
    dest: "/etc/wireguard/wg0.conf"
    owner: root
    mode: 0640
  become: true
