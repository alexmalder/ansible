---
- name: Run playbook locally for git mirror
  hosts: 127.0.0.1
  connection: local
  vars:
    src_url: https://gitlab.vnmntn.com/alexmalder
    dest_url: https://github.com/alexmalder
    dest_remote: dest
    repos:
      - ansible
      - observability
      - obsidian
      - reader
      - scraper
      - store
      - template
      - vault
  tasks:
    - name: Delete content & directory
      ansible.builtin.file:
        state: absent
        path: "/tmp/{{ item }}"
      with_items: "{{ repos }}"

    - name: Clone repositories into /tmp
      ansible.builtin.git:
        repo: "{{ src_url }}/{{ item }}"
        dest: "/tmp/{{ item }}"
        single_branch: true
        force: true
        version: master
      with_items: "{{ repos }}"

    - name: Remote add
      ansible.builtin.command: "git -C /tmp/{{ item }} remote add {{ dest_remote }} {{ dest_url }}/{{ item }}"
      with_items: "{{ repos }}"

    - name: Push
      ansible.builtin.command: "git -C /tmp/{{ item }} push -u {{ dest_remote }} master"
      with_items: "{{ repos }}"
